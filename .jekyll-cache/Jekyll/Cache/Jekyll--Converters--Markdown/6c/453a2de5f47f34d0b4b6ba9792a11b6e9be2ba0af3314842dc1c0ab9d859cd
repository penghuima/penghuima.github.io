I"…Å<ul id="markdown-toc">
  <li><a href="#é¡¹ç›®æ¦‚è¿°" id="markdown-toc-é¡¹ç›®æ¦‚è¿°">é¡¹ç›®æ¦‚è¿°</a></li>
  <li><a href="#æœ¬åœ°ç¯å¢ƒ" id="markdown-toc-æœ¬åœ°ç¯å¢ƒ">æœ¬åœ°ç¯å¢ƒ</a></li>
  <li><a href="#ä¾èµ–å·¥å…·" id="markdown-toc-ä¾èµ–å·¥å…·">ä¾èµ–å·¥å…·</a></li>
  <li><a href="#goland-é…ç½®è¿œç¨‹æœåŠ¡å™¨" id="markdown-toc-goland-é…ç½®è¿œç¨‹æœåŠ¡å™¨">Goland é…ç½®è¿œç¨‹æœåŠ¡å™¨</a></li>
  <li><a href="#build-ruby26-stack" id="markdown-toc-build-ruby26-stack">Build ruby26 stack</a>    <ul>
      <li><a href="#stack-æ¦‚è¿°" id="markdown-toc-stack-æ¦‚è¿°">stack æ¦‚è¿°</a></li>
      <li><a href="#ruby-26-runtime" id="markdown-toc-ruby-26-runtime">ruby 2.6 runtime</a></li>
      <li><a href="#ç”Ÿæˆ-stack" id="markdown-toc-ç”Ÿæˆ-stack">ç”Ÿæˆ stack</a></li>
      <li><a href="#ä¸Šä¼ é•œåƒ" id="markdown-toc-ä¸Šä¼ é•œåƒ">ä¸Šä¼ é•œåƒ</a></li>
    </ul>
  </li>
  <li><a href="#ç”Ÿæˆbuilder" id="markdown-toc-ç”Ÿæˆbuilder">ç”Ÿæˆbuilder</a>    <ul>
      <li><a href="#builderæ¦‚è¿°" id="markdown-toc-builderæ¦‚è¿°">builderæ¦‚è¿°</a></li>
      <li><a href="#buildpacks" id="markdown-toc-buildpacks">buildpacks</a></li>
      <li><a href="#ç”Ÿæˆ-builder" id="markdown-toc-ç”Ÿæˆ-builder">ç”Ÿæˆ builder</a></li>
    </ul>
  </li>
  <li><a href="#demo-å±•ç¤º" id="markdown-toc-demo-å±•ç¤º">Demo å±•ç¤º</a>    <ul>
      <li><a href="#ç”Ÿæˆ-app-image" id="markdown-toc-ç”Ÿæˆ-app-image">ç”Ÿæˆ app image</a></li>
      <li><a href="#è¿è¡Œæ—¥å¿—" id="markdown-toc-è¿è¡Œæ—¥å¿—">è¿è¡Œæ—¥å¿—</a></li>
    </ul>
  </li>
  <li><a href="#q--a" id="markdown-toc-q--a">Q &amp; A</a></li>
</ul>

<h3 id="é¡¹ç›®æ¦‚è¿°">é¡¹ç›®æ¦‚è¿°</h3>

<p>é¡¹ç›®ç›®æ ‡ï¼š å¼€å‘å¹¶ä¼˜åŒ–å‡½æ•°æ„å»ºå™¨ï¼Œä½¿å…¶å¯ä»¥è¯†åˆ« Ruby è¯­è¨€ï¼Œå¹¶å°†å‡½æ•°æ„å»ºæˆå¯ä»¥è¿è¡Œåœ¨ OpenFunction ä¸­çš„åº”ç”¨é•œåƒã€‚</p>

<p>é¡¹ç›®èƒŒæ™¯ï¼š OpenFunction æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿçš„å¼€æºå‡½æ•°å³æœåŠ¡ï¼ˆFunctions-as-a-Serviceï¼‰å¹³å°ï¼Œæ—¨åœ¨è®©ç”¨æˆ·ä¸“æ³¨äºä»–ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸å¿…æ‹…å¿ƒåº•å±‚è¿è¡Œç¯å¢ƒå’ŒåŸºç¡€è®¾æ–½ã€‚ç”¨æˆ·åªéœ€è¦ä»¥å‡½æ•°çš„å½¢å¼æäº¤ä¸šåŠ¡ç›¸å…³çš„æºä»£ç ï¼Œå³å¯å°†æœåŠ¡æŒ‰éœ€è¿è¡Œåœ¨é›†ç¾¤ä¸­ã€‚ Tekton æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿçš„ CI/CD é¡¹ç›®ã€‚ Cloud Native Buildpacks ï¼ˆä»¥ä¸‹ç®€ç§° Buildpacks ï¼‰æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿçš„ OCI æ ‡å‡†é•œåƒåˆ¶ä½œå·¥å…·ã€‚</p>

<p>é¡¹ç›®è¯¦æƒ…ï¼š OpenFunction çš„ builders ç»„ä»¶é›†æˆäº† Tekton ä¸ Buildpacks ï¼Œç”¨äºå®Œæˆå°†ç”¨æˆ·æäº¤çš„å‡½æ•°ä»£ç åˆ¶ä½œæˆå¯ä»¥è¿è¡Œåœ¨ Kubernetes ä¸­çš„åº”ç”¨è´Ÿè½½é•œåƒè¿™ä¸€éƒ¨åˆ†å·¥ä½œã€‚ Tekton è´Ÿè´£ç¼–æ’æ•´ä¸ªç”±ä»£ç åˆ°åº”ç”¨é•œåƒçš„åˆ¶ä½œè¿‡ç¨‹ï¼ŒåŒ…å«ï¼šæ‹‰å–é•œåƒã€å‡†å¤‡ç¯å¢ƒå˜é‡ã€ä½¿ç”¨ Buildpacks åˆ¶ä½œé•œåƒã€è¾“å‡ºé•œåƒåˆ°æŒ‡å®šä»“åº“ ç­‰å‡ ä¸ªä¸»è¦æ­¥éª¤ã€‚</p>

<p>Buildpacks è´Ÿè´£è¯†åˆ«ä»£ç çš„è¯­è¨€ç±»å‹ï¼Œç„¶åå‡†å¤‡å¥½ç›¸å…³çš„ç¼–è¯‘ç¯å¢ƒï¼Œå†å°†ä»£ç é€šè¿‡æ¨¡æ¿æ¸²æŸ“ä¸ºå¯è¿è¡Œçš„åº”ç”¨ã€‚ æˆ‘ä»¬å¸Œæœ›ï¼š å®ƒå¯ä»¥æ”¯æŒæ›´å¤šçš„ä¸»æµè¯­è¨€ï¼ˆåŠæ›´å¤šçš„è¯­è¨€ç‰ˆæœ¬ï¼‰ å¯ä»¥ä¼˜åŒ–ä»£ç æ„å»ºçš„ç­–ç•¥ã€å‡å°‘ä»£ç æ„å»ºçš„æ—¶é—´ã€‚</p>

<!--more-->

<h3 id="æœ¬åœ°ç¯å¢ƒ">æœ¬åœ°ç¯å¢ƒ</h3>

<ul>
  <li>Ubuntu 18.04.4   user:ubuntu</li>
  <li>CPU Core * 8</li>
  <li>Memory * 8G</li>
  <li>Goland 2020.3</li>
</ul>

<h3 id="ä¾èµ–å·¥å…·">ä¾èµ–å·¥å…·</h3>

<p>æ•´ä¸ªå¼€å‘è¿‡ç¨‹éœ€è¦éœ€è¦ container-structure-testã€Bazelã€packã€Docker è¿™äº›å·¥å…·ï¼Œç¡®ä¿è¿™äº›å·¥å…·çš„æ‰§è¡Œæ–‡ä»¶å¤„äº $PATH ç›®å½•ä¸‹ã€‚</p>

<ul>
  <li>
    <p>å®‰è£… Docker</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>docker.io
<span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker ubuntu
<span class="nb">sudo chmod </span>a+rw /var/run/docker.sock
<span class="nb">sudo </span>systemctl restart docker 
</code></pre></div>    </div>
  </li>
  <li>
    <p>å®‰è£…pack</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-sSL</span> <span class="s2">"https://github.com/buildpacks/pack/releases/download/v0.18.1/pack-v0.18.1-linux.tgz"</span> | <span class="nb">sudo tar</span> <span class="nt">-C</span> /usr/local/bin/ <span class="nt">--no-same-owner</span> <span class="nt">-xzv</span> pack
</code></pre></div>    </div>
  </li>
  <li>
    <p>å®‰è£…Bazel (v4.1.0)</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>g++ unzip zip
<span class="nb">sudo </span>apt-get <span class="nb">install </span>openjdk-11-jdk
wget https://github.com/bazelbuild/bazel/releases/download/4.1.0/bazel-4.1.0-installer-linux-x86_64.sh
<span class="nb">chmod</span> +x bazel-4.1.0-installer-linux-x86_64.sh
./bazel-4.1.0-installer-linux-x86_64.sh <span class="nt">--user</span>
<span class="nb">sudo mv</span> <span class="nv">$HOME</span>/bin/bazel /usr/local/bin
</code></pre></div>    </div>
  </li>
  <li>
    <p>å®‰è£… container-structure-test</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-LO</span> https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64 <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x container-structure-test-linux-amd64 <span class="o">&amp;&amp;</span> <span class="nb">sudo mv </span>container-structure-test-linux-amd64 /usr/local/bin/container-structure-test
</code></pre></div>    </div>
  </li>
  <li>
    <p>å»ºç«‹ä¸€æ¡ python3 è½¯è¿æ¥(å¯ä»¥ä¸éœ€è¦)</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ln</span> <span class="nt">-s</span> /usr/bin/python3 /usr/bin/python
</code></pre></div>    </div>
  </li>
</ul>

<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯æ˜¯å¦å·²å‡†å¤‡å¥½æ‰€æœ‰ä¾èµ–ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/OpenFunction/builder.git
<span class="nb">cd </span>builder
bazel <span class="nb">test</span> <span class="nt">--test_output</span><span class="o">=</span>errors tools/checktools:main_test
</code></pre></div></div>

<p>å¦‚æœå‡ºç°ç±»  INFO: Build completed successfully, 9 total actions æç¤ºä¿¡æ¯ï¼Œè¯´æ˜å·²ç»æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ</p>

<h3 id="goland-é…ç½®è¿œç¨‹æœåŠ¡å™¨">Goland é…ç½®è¿œç¨‹æœåŠ¡å™¨</h3>

<p>è¿æ¥è¿œç¨‹æœåŠ¡å™¨ï¼Œå¹¶é…ç½®æ–‡ä»¶åŒæ­¥è·¯å¾„</p>

<p><img src="https://cdn.jsdelivr.net/gh/penghuima/ImageBed@master/img/blog_file/PicGo-Github-ImgBedimage-20210814111538411.png" alt="image-20210814111538411" /></p>

<p><img src="https://cdn.jsdelivr.net/gh/penghuima/ImageBed@master/img/blog_file/PicGo-Github-ImgBedimage-20210814111619937.png" alt="image-20210814111619937" /></p>

<blockquote>
  <p><a href="https://www.jetbrains.com/help/go/creating-a-remote-server-configuration.html">Create a remote server configuration</a></p>

  <p><a href="https://blog.csdn.net/huwh_/article/details/77879152?utm_source=blogxgwz3">GolandåŒæ­¥æ’ä»¶é…ç½®</a></p>
</blockquote>

<h3 id="build-ruby26-stack">Build ruby26 stack</h3>

<h4 id="stack-æ¦‚è¿°">stack æ¦‚è¿°</h4>

<p>Stack çš„åŠŸèƒ½æ˜¯æä¾›åŸºç¡€è¿è¡Œç¯å¢ƒï¼Œå®ƒåŒ…å«ä¸¤ç§é•œåƒï¼š</p>

<ul>
  <li>
    <p>build ï¼Œä¸º Lifecycle çš„ Build é˜¶æ®µæä¾›è¿è¡Œç¯å¢ƒ</p>
  </li>
  <li>
    <p>run ï¼Œä¸ºä¸šåŠ¡åº”ç”¨æä¾›è¿è¡Œç¯å¢ƒ</p>
  </li>
</ul>

<p>åœ¨æœ¬é¡¹ç›®Openfunctionçš„Rubyå‡½æ•°æ„å»ºå™¨å¼€å‘ä¸­ï¼Œéœ€è¦å…ˆå‡†å¤‡ä¸€ä¸ªéƒ¨ç½²æœ‰Ruby2.6 runtime çš„ stack ï¼Œstack æœ¬è´¨ä¸ºä¸€ä¸ªåŸºç¡€è¿è¡Œç¯å¢ƒï¼Œåœ¨åˆ¶ä½œè¿‡ç¨‹ä¸­åŠ å…¥ LABEL io.buildpacks.stack.id å³å¯ä»¥æŒ‡å®š stack çš„æ ‡è¯†ã€‚</p>

<blockquote>
  <p>åŸç”Ÿ gcp/buildpacks å°†ä¸‹è½½è¯­è¨€ runtime çš„æ­¥éª¤æ”¾ç½®åœ¨ buildpack ä¸­ï¼Œå³åœ¨æ¢æµ‹åˆ°è¯­è¨€ç±»å‹åå†ä¸‹è½½å®‰è£…å¯¹åº”çš„è¯­è¨€ runtime ï¼Œæœ¬é¡¹ç›®é€‰æ‹©å°†è¯­è¨€ runtime å®‰è£…åœ¨ stack ä¸­ï¼Œä»¥å‡å°‘å‡½æ•°æ„å»ºè¿‡ç¨‹ä¸­çš„æ—¶é—´</p>
</blockquote>

<h4 id="ruby-26-runtime">ruby 2.6 runtime</h4>

<p>æœ¬é¡¹ç›®è‡ªå®šä¹‰çš„ ruby2.6 stack ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM gcr.io/gcp-runtimes/ubuntu_18_0_4
ARG <span class="nv">cnb_uid</span><span class="o">=</span>1000
ARG <span class="nv">cnb_gid</span><span class="o">=</span>1000
ARG <span class="nv">stack_id</span><span class="o">=</span><span class="s2">"openfunction.ruby26"</span>
<span class="c"># Required by python/runtime: libexpat1, libffi6, libmpdecc2.</span>
<span class="c"># Required by dotnet/runtime: libicu60</span>
<span class="c"># Required by go/runtime: tzdata (Go may panic without /usr/share/zoneinfo)</span>
RUN apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> <span class="se">\</span>
  libexpat1 <span class="se">\</span>
  libffi6 <span class="se">\</span>
  libmpdec2 <span class="se">\</span>
  libicu60 <span class="se">\</span>
  libc++1-9 <span class="se">\</span>
  tzdata <span class="se">\</span>
  gcc libc6-dev make  zlib1g zlib1g-dev  openssl libssl-dev <span class="se">\</span>
  <span class="o">&amp;&amp;</span> apt-get clean <span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>

LABEL io.buildpacks.stack.id<span class="o">=</span><span class="k">${</span><span class="nv">stack_id</span><span class="k">}</span>

RUN groupadd cnb <span class="nt">--gid</span> <span class="k">${</span><span class="nv">cnb_gid</span><span class="k">}</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
  useradd <span class="nt">--uid</span> <span class="k">${</span><span class="nv">cnb_uid</span><span class="k">}</span> <span class="nt">--gid</span> <span class="k">${</span><span class="nv">cnb_gid</span><span class="k">}</span> <span class="nt">-m</span> <span class="nt">-s</span> /bin/bash cnb

<span class="c"># install ruby runtime</span>
RUN <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> <span class="nb">mkdir </span>ruby <span class="o">&amp;&amp;</span> <span class="nb">cd </span>ruby <span class="o">&amp;&amp;</span> curl  https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.6.tar.gz | <span class="nb">tar </span>xz <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd </span>ruby-2.6.6 <span class="o">&amp;&amp;</span> ./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make <span class="nb">install</span>  <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd </span>ext/zlib <span class="se">\</span>
    <span class="o">&amp;&amp;</span> ruby extconf.rb <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s?$(top_srcdir)?../..?g'</span> Makefile  <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make <span class="nb">install</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ../openssl <span class="se">\</span>
    <span class="o">&amp;&amp;</span> ruby extconf.rb <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s?$(top_srcdir)?../..?g'</span> Makefile <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make <span class="nb">install</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> gem uninstall bundle <span class="o">&amp;&amp;</span> gem <span class="nb">install </span>bundler <span class="nt">-v</span> 2.1.4 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ../../

ENV <span class="nv">CNB_USER_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">cnb_uid</span><span class="k">}</span>
ENV <span class="nv">CNB_GROUP_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">cnb_gid</span><span class="k">}</span>
ENV <span class="nv">CNB_STACK_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">stack_id</span><span class="k">}</span>
</code></pre></div></div>

<blockquote>
  <p>å®Œæ•´æ–‡ä»¶è¯·å‚è€ƒ <a href="ruby26/stack">ruby26/stack</a></p>
</blockquote>

<h4 id="ç”Ÿæˆ-stack">ç”Ÿæˆ stack</h4>

<p>å¼€å§‹åœ¨æ ¹ç›®å½• builder/ ä¸‹æ‰§è¡Œ ruby2.6 stack æ„å»ºå‘½ä»¤</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel run //builders/ruby26/stack:build
</code></pre></div></div>

<p>This command creates three images:</p>

<ul>
  <li><strong>ruby26common</strong></li>
  <li><strong>openfunctiondev/buildpacks-ruby26-run:v1</strong></li>
  <li><strong>openfunctiondev/buildpacks-ruby26-build:v1</strong></li>
</ul>

<p>å¦‚ä¸‹æ‰€ç¤º</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@i-a1kwg7lk:~/mph/builder<span class="nv">$ </span>docker images
REPOSITORY                                TAG       IMAGE ID       CREATED         SIZE
openfunctiondev/buildpacks-ruby26-build   v1        18a6f7e4c4b6   3 minutes ago   1.04GB
openfunctiondev/buildpacks-ruby26-run     v1        e221e925ecc5   4 minutes ago   791MB
ruby26common                              latest    c21fa60b9e9c   4 minutes ago   791MB
gcr.io/gcp-runtimes/ubuntu_18_0_4         latest    93a9bd0cfd2e   51 years ago    76.7MB
</code></pre></div></div>

<p>éªŒè¯ ruby 2.6 runtime</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@i-a1kwg7lk:~/mph/builder<span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">--name</span> build-runtime openfunctiondev/buildpacks-ruby26-build:v1 /bin/bash
cnb@67882f6e62ab:/<span class="nv">$ </span>which ruby
/usr/local/bin/ruby
cnb@67882f6e62ab:/<span class="nv">$ </span>bundle <span class="nt">-v</span>
Bundler version 2.1.4

ubuntu@i-a1kwg7lk:~/mph/builder<span class="nv">$ </span>docker run <span class="nt">-it</span> <span class="nt">--name</span> run-runtime openfunctiondev/buildpacks-ruby26-run:v1 /bin/bash
cnb@704a89adc952:/<span class="nv">$ </span>which ruby
/usr/local/bin/ruby
cnb@704a89adc952:/<span class="nv">$ </span>bundle <span class="nt">-v</span>
Bundler version 2.1.4
</code></pre></div></div>

<h4 id="ä¸Šä¼ é•œåƒ">ä¸Šä¼ é•œåƒ</h4>

<p>å¯ä»¥å°† build å’Œ run é•œåƒä¸Šä¼ åˆ°è‡ªå·±çš„é•œåƒä»“åº“</p>

<p>docker login -u xxxxx(dockerhubæ³¨å†Œçš„dockerç”¨æˆ·å)ï¼Œç™»å½•dockeræˆåŠŸ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login <span class="nt">-u</span> penghuima
docker tag openfunctiondev/buildpacks-ruby26-build:v1 penghuima/buildpacks-ruby26-build:v1
docker tag openfunctiondev/buildpacks-ruby26-run:v1 penghuima/buildpacks-ruby26-run:v1
docker push penghuima/buildpacks-ruby26-build:v1
docker push penghuima/buildpacks-ruby26-run:v1
</code></pre></div></div>

<h3 id="ç”Ÿæˆbuilder">ç”Ÿæˆbuilder</h3>

<h4 id="builderæ¦‚è¿°">builderæ¦‚è¿°</h4>

<p>Builder æè¿°äº†ä¸€ä¸ªå®Œæ•´çš„æ„å»ºç¼–æ’é€»è¾‘ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯å°†  Stack åŠè‹¥å¹²ä¸ª Buildpack ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªä¸šåŠ¡é€»è¾‘æ˜ç¡®çš„æ„å»ºå·¥å…·ã€‚Builderæ˜¯ä¸€ä¸ªé•œåƒï¼Œå…¶ä¸­åŒ…å«æ‰§è¡Œæ„å»ºæ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ã€‚æ„å»ºå™¨é•œåƒæ˜¯é€šè¿‡stacké•œåƒå¹¶æ·»åŠ ç”Ÿå‘½å‘¨æœŸã€æ„å»ºåŒ…å’Œæ–‡ä»¶æ¥åˆ›å»ºçš„ï¼Œè¿™äº›æ–‡ä»¶é…ç½®æ„å»ºçš„å„ä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬æ„å»ºåŒ…æ£€æµ‹é¡ºåºå’Œè¿è¡Œé•œåƒçš„ä½ç½®ã€‚</p>

<p><img src="https://buildpacks.io/docs/concepts/components/create-builder.svg" alt="create-builder diagram" /></p>

<p>æœ¬é¡¹ç›®builderçš„å®šä¹‰æ–‡ä»¶ builder.tomlå†…å®¹å¦‚ä¸‹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>description <span class="o">=</span> <span class="s2">"Builder for the  Ruby 2.6"</span>

<span class="o">[[</span>buildpacks]]
  <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby.functions-framework"</span>
  uri <span class="o">=</span> <span class="s2">"ruby/functions_framework.tgz"</span>

<span class="o">[[</span>buildpacks]]
  <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby.bundle"</span>
  uri <span class="o">=</span> <span class="s2">"ruby/bundle.tgz"</span>

<span class="o">[[</span>buildpacks]]
  <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.config.entrypoint"</span>
  uri <span class="o">=</span> <span class="s2">"entrypoint.tgz"</span>

<span class="o">[[</span>buildpacks]]
  <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.utils.label"</span>
  uri <span class="o">=</span> <span class="s2">"label.tgz"</span>

<span class="o">[[</span>order]]

  <span class="o">[[</span>order.group]]
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby.bundle"</span>

  <span class="o">[[</span>order.group]]
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby.functions-framework"</span>

  <span class="o">[[</span>buildpacks]]
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.config.entrypoint"</span>

  <span class="o">[[</span>order.group]]
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.utils.label"</span>

<span class="o">[</span>stack]
  <span class="nb">id</span> <span class="o">=</span> <span class="s2">"openfunction.ruby26"</span>
  build-image <span class="o">=</span> <span class="s2">"openfunctiondev/buildpacks-ruby26-build:v1"</span>
  run-image <span class="o">=</span> <span class="s2">"openfunctiondev/buildpacks-ruby26-run:v1"</span>

<span class="o">[</span>lifecycle]
  version <span class="o">=</span> <span class="s2">"0.11.1"</span>
</code></pre></div></div>

<ul>
  <li>[[buildpacks]] è¡¨ç¤ºå¼•å…¥çš„ buildpack ï¼Œå·²ç»ç”¨ bazel å·¥å…·å°†ç›¸å…³ä»£ç ç›®å½•æ‰“åŒ…æˆäº† tgz æ–‡ä»¶ï¼Œå°±æ˜¯å°è£…äº† /bin/detect å’Œ /bin/build ä¸¤ä¸ªåŠŸèƒ½ã€‚</li>
  <li>[[order]] [[order.group]] è¡¨ç¤º buildpack çš„æ‰§è¡Œé¡ºåºï¼Œä»ä¸‹æ–‡ of/ruby26é•œåƒæ„æˆçš„ appé•œåƒè¿è¡Œæ—¥å¿—ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¿è¡Œæ£€æµ‹é¡ºåºä¸ [[order]] é¡ºåºä¸€è‡´</li>
  <li>[stack] è¡¨ç¤ºå¼•ç”¨çš„ stack å†…å®¹ï¼Œå…¶ä¸­stack id å”¯ä¸€æ ‡è¯†æˆ‘ä»¬ä¸Šæ–‡ä¸­åˆ›å»ºçš„ stack</li>
  <li>[lifecycle] è¡¨ç¤ºä½¿ç”¨çš„ lifecycle æ¨¡å—çš„ç‰ˆæœ¬</li>
</ul>

<h4 id="buildpacks">buildpacks</h4>

<p>Buildpack å¯ä»¥ç†è§£ä¸ºä»»åŠ¡å•ä¸€çš„æ„å»ºå•å…ƒï¼Œç”¨äºæ£€æŸ¥æ‚¨çš„åº”ç”¨ç¨‹åºæºä»£ç å¹¶åˆ¶å®šæ„å»ºå’Œè¿è¡Œåº”ç”¨ç¨‹åºçš„è®¡åˆ’ã€‚æ¯ä¸€ä¸ª buildpack éƒ½å…·å¤‡ä»¥ä¸‹ä¸‰ä¸ªå…ƒç´ ï¼š</p>

<ul>
  <li>buildpack.toml ï¼Œæè¿°äº† buildpack çš„å…ƒæ•°æ®ã€‚</li>
  <li>bin/detect ï¼ŒLifecycle ä¸­ Detect é˜¶æ®µçš„å®ç°ï¼Œç¡®å®šæ˜¯å¦åº”ç”¨è¯¥buildpackã€‚</li>
  <li>bin/build ï¼ŒLifecycle ä¸­ Build é˜¶æ®µçš„å®ç°ï¼Œæ‰§è¡Œbuildpacké€»è¾‘ã€‚</li>
</ul>

<p>å®ƒçš„å·¥ä½œåŸç†å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šbin/detect å°†ä¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›å…¥è¯¥ buildpack ï¼Œå¦‚æœå¯ä»¥è¿›å…¥è¯¥ buildpack ï¼Œé‚£ä¹ˆ Lifecycle å°±ä¼šæŒ‡å¯¼æµç¨‹è¿›å…¥ Build é˜¶æ®µåŒæ—¶è§¦å‘ bin/build æ‰§è¡Œã€‚</p>

<p>æ¯ä¸ª buildpack å®Œæˆåéƒ½ä¼šäº§å‡ºä¸€ä»½æ¸…å•ï¼Œç”¨äºè¡¨æ˜è‡ªå·±äº§å‡ºäº†ä»€ä¹ˆå†…å®¹ï¼ˆå¯ä¸ºç©ºï¼‰ï¼Œä¸”å¦‚æœè¦å®Œæˆåç»­çš„ buildpack è¿‡ç¨‹ï¼Œè¿˜éœ€è¦ä»€ä¹ˆå†…å®¹ï¼ˆå¯ä¸ºç©ºï¼‰ã€‚</p>

<p>åŒæ—¶åœ¨ Build é˜¶æ®µï¼ŒåŸºäºå¤ç”¨æ„å»ºé€»è¾‘çš„åŸåˆ™ï¼Œbuildpack çš„ä½œè€…å¯ä»¥è®¾ç½®ä¸é€šè¿‡çš„ layer ï¼ˆlayer å†…ä¿å­˜äº†æ‰€å…³è”çš„æ„å»ºè¿‡ç¨‹çš„ç»“æœï¼Œå¦‚æ–‡ä»¶ã€è¿è¡Œæ—¶ç­‰å†…å®¹ï¼‰ï¼Œå¹¶è®¾ç½® build ã€launch ã€cache ä¸‰ç§å±æ€§ã€‚Lifecycle å°†æ ¹æ®è¿™ä¸‰ä¸ªå‚æ•°çš„ç»„åˆæ¥å†³å®šæ˜¯å¦å¤ç”¨ä¸€ä¸ª layerã€‚</p>

<p>ä»¥ id ä¸º  â€œgoogle.ruby.functions-frameworkâ€ çš„ ruby å‡½æ•°æ¡†æ¶è¿™ä¸€ buildpack ä¸ºä¾‹ï¼Œå…¶å…ƒæ•°æ®åœ¨ [buildpack] ä¸­å®šä¹‰ï¼Œ[[stacks]] ç”¨äºæè¿° buildpack å¯ä»¥è¿è¡Œåœ¨å“ªäº› stack ä¸Š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>api <span class="o">=</span> <span class="s2">"0.2"</span>

<span class="o">[</span>buildpack]
<span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby.functions-framework"</span>
version <span class="o">=</span> <span class="s2">"0.9.1"</span>
name <span class="o">=</span> <span class="s2">"Ruby - Functions Framework"</span>

<span class="o">[[</span>stacks]]
<span class="nb">id</span> <span class="o">=</span> <span class="s2">"openfunction.ruby26"</span>

<span class="o">[[</span>stacks]]
<span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby27"</span>
</code></pre></div></div>

<h4 id="ç”Ÿæˆ-builder">ç”Ÿæˆ builder</h4>

<p>å¼€å§‹åœ¨æ ¹ç›®å½• builder/ ä¸‹æ‰§è¡Œ ruby2.6 builder æ„å»ºå‘½ä»¤</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel build //builders/ruby26:builder.image
</code></pre></div></div>

<p>This command creates one image:</p>

<ul>
  <li><strong>of/ruby26</strong></li>
</ul>

<p>ç”Ÿæˆ builder æ—¥å¿—</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@i-a1kwg7lk:~/mph/builder<span class="nv">$ </span>bazel build //builders/ruby26:builder.image
INFO: Analyzed target //builders/ruby26:builder.image <span class="o">(</span>54 packages loaded, 6870 targets configured<span class="o">)</span><span class="nb">.</span>
INFO: Found 1 target...
INFO: From Executing genrule //builders/ruby26:builder.image:
2021/08/14 14:58:20 Checking tools
2021/08/14 14:58:20 pack found at /usr/local/bin/pack
2021/08/14 14:58:20 docker found at /usr/bin/docker
2021/08/14 14:58:20 container-structure-test found at /usr/local/bin/container-structure-test
2021/08/14 14:58:20 Checking pack version
2021/08/14 14:58:20 Found pack version 0.18.1+git-b5c1a96.build-2373
Extracting builder <span class="nb">tar</span>:
./
./builder.toml
./label.tgz
./ruby/
./ruby/functions_framework.tgz
./ruby/bundle.tgz
Warning: Command <span class="s1">'pack create-builder'</span> has been deprecated, please use <span class="s1">'pack builder create'</span> instead
Downloading from <span class="s1">'https://github.com/buildpacks/lifecycle/releases/download/v0.11.1/lifecycle-v0.11.1+linux.x86-64.tgz'</span>
5.25 MB/5.25 MB
Successfully created builder image <span class="s1">'of/ruby26'</span>
Tip: Run <span class="s1">'pack build &lt;image-name&gt; --builder of/ruby26'</span> to use this builder
Target //builders/ruby26:builder.image up-to-date:
  bazel-bin/builders/ruby26/builder.sha
INFO: Elapsed <span class="nb">time</span>: 14.209s, Critical Path: 12.22s
INFO: 48 processes: 19 internal, 28 linux-sandbox, 1 local.
INFO: Build completed successfully, 48 total actions
</code></pre></div></div>

<h3 id="demo-å±•ç¤º">Demo å±•ç¤º</h3>

<p>æœ¬èŠ‚é€šè¿‡å±•ç¤ºä¸€ä¸ªç®€å•çš„  hello  word ä¾‹å­æ¥æ¼”ç¤º builder æ˜¯å¦‚ä½•å·¥ä½œçš„</p>

<blockquote>
  <p>git clone https://github.com/penghuima/samples.git</p>

  <p>cd  samples/functions/Knative/hello-world-ruby/</p>
</blockquote>

<p>sampleé‡Œä¸»è¦æœ‰ä¸‰ä¸ªæ–‡ä»¶ app.rbã€Gemfileã€Gemfile.lock å†…å®¹å¦‚ä¸‹</p>

<ul>
  <li>
    <p>app.rb</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"functions_framework"</span>
<span class="no">FunctionsFramework</span><span class="p">.</span><span class="nf">http</span><span class="p">(</span><span class="s2">"Hello-World"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">request</span><span class="o">|</span>
  <span class="s2">"Hello, world!  Hello Ruby!</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Gemfile</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="s2">"https://rubygems.org"</span>
<span class="n">gem</span> <span class="s2">"functions_framework"</span><span class="p">,</span> <span class="s2">"~&gt; 1.0"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Gemfile.lock</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">GEM</span>
  <span class="ss">remote: </span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">rubygems</span><span class="p">.</span><span class="nf">org</span><span class="o">/</span>
  <span class="ss">specs:
    </span><span class="n">cloud_events</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">functions_framework</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">cloud_events</span> <span class="p">(</span><span class="o">&gt;=</span> <span class="mf">0.5</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="nf">a</span><span class="p">)</span>
      <span class="n">puma</span> <span class="p">(</span><span class="o">&gt;=</span> <span class="mf">4.3</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">.</span><span class="nf">a</span><span class="p">)</span>
      <span class="n">rack</span> <span class="p">(</span><span class="o">~&gt;</span> <span class="mf">2.1</span><span class="p">)</span>
    <span class="n">nio4r</span> <span class="p">(</span><span class="mf">2.5</span><span class="o">.</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">puma</span> <span class="p">(</span><span class="mf">5.3</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">nio4r</span> <span class="p">(</span><span class="o">~&gt;</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">rack</span> <span class="p">(</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>
  
<span class="no">PLATFORMS</span>
  <span class="n">ruby</span>
  
<span class="no">DEPENDENCIES</span>
  <span class="n">functions_framework</span> <span class="p">(</span><span class="o">~&gt;</span> <span class="mf">1.0</span><span class="p">)</span>
  
<span class="no">BUNDLED</span> <span class="no">WITH</span>
   <span class="mf">2.1</span><span class="o">.</span><span class="mi">4</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="ç”Ÿæˆ-app-image">ç”Ÿæˆ app image</h4>

<p>åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”± builderé•œåƒå’Œæºç æ–‡ä»¶ ç”Ÿæˆ app images</p>

<p><img src="https://buildpacks.io/docs/concepts/operations/build.svg" alt="build diagram" /></p>

<p>Download samples:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/penghuima/samples.git    
<span class="nb">cd  </span>samples/functions/Knative/hello-world-ruby/
</code></pre></div></div>

<p>Build the function:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pack build <span class="k">function</span><span class="nt">-ruby</span> <span class="nt">--builder</span> of/ruby26 <span class="nt">--env</span> <span class="nv">FUNC_NAME</span><span class="o">=</span><span class="s2">"Hello-World"</span>
docker run <span class="nt">--rm</span> <span class="nt">-p8080</span>:8080 <span class="k">function</span><span class="nt">-ruby</span>
</code></pre></div></div>

<p>Visit the function:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://localhost:8080
</code></pre></div></div>

<p>Output example:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, world!  Hello Ruby!
</code></pre></div></div>

<h4 id="è¿è¡Œæ—¥å¿—">è¿è¡Œæ—¥å¿—</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@i-a1kwg7lk:~/mph/samples/functions/Knative/hello-world-ruby<span class="nv">$ </span>pack build <span class="k">function</span><span class="nt">-ruby</span> <span class="nt">--builder</span> of/ruby26 <span class="nt">--env</span> <span class="nv">FUNC_NAME</span><span class="o">=</span><span class="s2">"Hello-World"</span>
v1: Pulling from openfunctiondev/buildpacks-ruby26-run
Digest: sha256:f428f2272085771fd21353d3c3ba58ce1e755f47608dc11e2bd19d5f85df4066
Status: Image is up to <span class="nb">date </span><span class="k">for </span>openfunctiondev/buildpacks-ruby26-run:v1
0.11.1: Pulling from buildpacksio/lifecycle
Digest: sha256:2ca9870d9472400792bdc2d43ded8df2642ffcf937e8cd01685836678c28780b
Status: Image is up to <span class="nb">date </span><span class="k">for </span>buildpacksio/lifecycle:0.11.1
<span class="o">===&gt;</span> DETECTING
<span class="o">[</span>detector] google.ruby.bundle              0.9.0
<span class="o">[</span>detector] google.ruby.functions-framework 0.9.1
<span class="o">[</span>detector] google.utils.label              0.0.1
<span class="o">===&gt;</span> ANALYZING
<span class="o">[</span>analyzer] Previous image with name <span class="s2">"function-ruby"</span> not found
<span class="o">===&gt;</span> RESTORING
<span class="o">===&gt;</span> BUILDING
<span class="o">[</span>builder] <span class="o">===</span> Ruby - Bundle <span class="o">(</span>google.ruby.bundle@0.9.0<span class="o">)</span> <span class="o">===</span>
<span class="o">[</span>builder] Installing application dependencies.
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle config --local without development test"</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle config --local without development test"</span> <span class="o">(</span>213.701121ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle config --local path .bundle/gems"</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle config --local path .bundle/gems"</span> <span class="o">(</span>204.372547ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle lock --add-platform x86_64-linux"</span>
<span class="o">[</span>builder] Fetching gem metadata from https://rubygems.org/...
<span class="o">[</span>builder] Resolving dependencies...
<span class="o">[</span>builder] Writing lockfile to /workspace/Gemfile.lock
<span class="o">[</span>builder] Done <span class="s2">"bundle lock --add-platform x86_64-linux"</span> <span class="o">(</span>4.131479657s<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle lock --add-platform ruby"</span>
<span class="o">[</span>builder] Fetching gem metadata from https://rubygems.org/..
<span class="o">[</span>builder] Writing lockfile to /workspace/Gemfile.lock
<span class="o">[</span>builder] Done <span class="s2">"bundle lock --add-platform ruby"</span> <span class="o">(</span>1.109658296s<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle config --local deployment true"</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle config --local deployment true"</span> <span class="o">(</span>206.397619ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle config --local frozen true"</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle config --local frozen true"</span> <span class="o">(</span>192.510552ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle config --local without development test"</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle config --local without development test"</span> <span class="o">(</span>214.752127ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle config --local path .bundle/gems"</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle config --local path .bundle/gems"</span> <span class="o">(</span>218.378794ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle install (NOKOGIRI_USE_SYSTEM_LIBRARIES=1 MALLOC_ARENA_MAX=2 LANG=C.utf8)"</span>
<span class="o">[</span>builder] Fetching gem metadata from https://rubygems.org/..
<span class="o">[</span>builder] Using bundler 2.1.4
<span class="o">[</span>builder] Fetching cloud_events 0.5.1
<span class="o">[</span>builder] Installing cloud_events 0.5.1
<span class="o">[</span>builder] Fetching nio4r 2.5.7
<span class="o">[</span>builder] Installing nio4r 2.5.7 with native extensions
<span class="o">[</span>builder] Fetching puma 5.3.2
<span class="o">[</span>builder] Installing puma 5.3.2 with native extensions
<span class="o">[</span>builder] Fetching rack 2.2.3
<span class="o">[</span>builder] Installing rack 2.2.3
<span class="o">[</span>builder] Fetching functions_framework 1.0.0
<span class="o">[</span>builder] Installing functions_framework 1.0.0
<span class="o">[</span>builder] Bundle <span class="nb">complete</span><span class="o">!</span> 1 Gemfile dependency, 6 gems now installed.
<span class="o">[</span>builder] Gems <span class="k">in </span>the <span class="nb">groups </span>development and <span class="nb">test </span>were not installed.
<span class="o">[</span>builder] Bundled gems are installed into <span class="sb">`</span>./.bundle/gems<span class="sb">`</span>
<span class="o">[</span>builder] Done <span class="s2">"bundle install (NOKOGIRI_USE_SYSTEM_LIBRARIES=1 MALLOC_ARENA..."</span> <span class="o">(</span>8.561774732s<span class="o">)</span>
<span class="o">[</span>builder] <span class="o">===</span> Ruby - Functions Framework <span class="o">(</span>google.ruby.functions-framework@0.9.1<span class="o">)</span> <span class="o">===</span>
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] Running <span class="s2">"bundle exec functions-framework-ruby --quiet --verify --source app.rb --target Hello-World (MALLOC_ARENA_MAX=2 LANG=C.utf8 RACK_ENV=production)"</span>
<span class="o">[</span>builder] OK
<span class="o">[</span>builder] Done <span class="s2">"bundle exec functions-framework-ruby --quiet --verify --sour..."</span> <span class="o">(</span>319.197753ms<span class="o">)</span>
<span class="o">[</span>builder] <span class="o">===</span> Utils - Label Image <span class="o">(</span>google.utils.label@0.0.1<span class="o">)</span> <span class="o">===</span>
<span class="o">===&gt;</span> EXPORTING
<span class="o">[</span>exporter] Adding layer <span class="s1">'google.ruby.bundle:gems'</span>
<span class="o">[</span>exporter] Adding layer <span class="s1">'google.ruby.functions-framework:functions-framework'</span>
<span class="o">[</span>exporter] Adding 1/1 app layer<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>exporter] Adding layer <span class="s1">'launcher'</span>
<span class="o">[</span>exporter] Adding layer <span class="s1">'config'</span>
<span class="o">[</span>exporter] Adding layer <span class="s1">'process-types'</span>
<span class="o">[</span>exporter] Adding label <span class="s1">'io.buildpacks.lifecycle.metadata'</span>
<span class="o">[</span>exporter] Adding label <span class="s1">'io.buildpacks.build.metadata'</span>
<span class="o">[</span>exporter] Adding label <span class="s1">'io.buildpacks.project.metadata'</span>
<span class="o">[</span>exporter] Setting default process <span class="nb">type</span> <span class="s1">'web'</span>
<span class="o">[</span>exporter] Saving <span class="k">function</span><span class="nt">-ruby</span>...
<span class="o">[</span>exporter] <span class="k">***</span> Images <span class="o">(</span>d46c60a6b4b8<span class="o">)</span>:
<span class="o">[</span>exporter]       <span class="k">function</span><span class="nt">-ruby</span>
<span class="o">[</span>exporter] Adding cache layer <span class="s1">'google.ruby.bundle:gems'</span>
Successfully built image <span class="k">function</span><span class="nt">-ruby</span>
ubuntu@i-a1kwg7lk:~/mph/samples/functions/Knative/hello-world-ruby<span class="nv">$ </span>docker images
REPOSITORY                                TAG       IMAGE ID       CREATED        SIZE
openfunctiondev/buildpacks-ruby26-build   v1        18a6f7e4c4b6   6 hours ago    1.04GB
openfunctiondev/buildpacks-ruby26-run     v1        e221e925ecc5   6 hours ago    791MB
buildpacksio/lifecycle                    0.11.1    67c0e8a0dbed   41 years ago   15.7MB
of/ruby26                                 latest    19d1b18882a7   41 years ago   1.07GB
<span class="k">function</span><span class="nt">-ruby</span>                             latest    d46c60a6b4b8   41 years ago   801MB
ubuntu@i-a1kwg7lk:~/mph/samples/functions/Knative/hello-world-ruby<span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-p8080</span>:8080 <span class="k">function</span><span class="nt">-ruby</span>
I, <span class="o">[</span>2021-08-14T09:41:20.648220 <span class="c">#1]  INFO -- : FunctionsFramework v1.0.0</span>
I, <span class="o">[</span>2021-08-14T09:41:20.648325 <span class="c">#1]  INFO -- : FunctionsFramework: Loading functions from "./app.rb"...</span>
I, <span class="o">[</span>2021-08-14T09:41:20.648584 <span class="c">#1]  INFO -- : FunctionsFramework: Looking for function name "Hello-World"...</span>
I, <span class="o">[</span>2021-08-14T09:41:20.648653 <span class="c">#1]  INFO -- : FunctionsFramework: Starting server...</span>
I, <span class="o">[</span>2021-08-14T09:41:20.715425 <span class="c">#1]  INFO -- : FunctionsFramework: Serving function "Hello-World" on port 8080...</span>
ubuntu@i-a1kwg7lk:~<span class="nv">$ </span>curl http://localhost:8080
Hello, world!  Hello Ruby!
</code></pre></div></div>

<h3 id="q--a">Q &amp; A</h3>

<p><strong>Q1:</strong> ERROR: failed to add buildpacks to builder: downloading buildpack: extracting from registry â€˜bundle.tgzâ€™: fetching image: image â€˜bundle.tgzâ€™ does not exist on the daemon: not found
Extracting builder tar:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openfunction6@cloudshell:~/mph/builder<span class="nv">$ </span>bazel build //builders/ruby26:builder.image
INFO: Analyzed target //builders/ruby26:builder.image <span class="o">(</span>1 packages loaded, 5 targets configured<span class="o">)</span><span class="nb">.</span>
INFO: Found 1 target...
ERROR: /home/openfunction6/mph/builder/builders/ruby26/BUILD.bazel:7:8: Executing genrule //builders/ruby26:builder.image failed: <span class="o">(</span>Exit 1<span class="o">)</span>: bash failed: error executing <span class="nb">command</span> /bin/bash <span class="nt">-c</span> ... <span class="o">(</span>remaining 1 argument<span class="o">(</span>s<span class="o">)</span> skipped<span class="o">)</span>
2021/08/04 09:09:31 Checking tools
2021/08/04 09:09:31 pack found at /usr/local/bin/pack
2021/08/04 09:09:31 docker found at /usr/bin/docker
2021/08/04 09:09:31 container-structure-test found at /usr/local/bin/container-structure-test
2021/08/04 09:09:31 Checking pack version
2021/08/04 09:09:31 Found pack version 0.20.0+git-66a4f32.build-2668
ERROR: failed to add buildpacks to builder: downloading buildpack: extracting from registry <span class="s1">'bundle.tgz'</span>: fetching image: image <span class="s1">'bundle.tgz'</span> does not exist on the daemon: not found
Extracting builder <span class="nb">tar</span>:
./
./builder.toml
./label.tgz
./ruby/
./ruby/bundle.tgz
./ruby/functions_framework.tgz
Warning: Command <span class="s1">'pack create-builder'</span> has been deprecated, please use <span class="s1">'pack builder create'</span> instead
Downloading from <span class="s1">'https://github.com/buildpacks/lifecycle/releases/download/v0.11.1/lifecycle-v0.11.1+linux.x86-64.tgz'</span>
5.25 MB/5.25 MB
Target //builders/ruby26:builder.image failed to build
Use <span class="nt">--verbose_failures</span> to see the <span class="nb">command </span>lines of failed build steps.
</code></pre></div></div>

<p><strong>A1:</strong> è¿™æ˜¯ç”±äº builder.toml é‡Œçš„è·¯å¾„è®¾ç½®ä¸æ­£ç¡®å¯¼è‡´ï¼Œæ­£ç¡®è·¯å¾„ä¸º</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[[</span>buildpacks]]
  <span class="nb">id</span> <span class="o">=</span> <span class="s2">"google.ruby.bundle"</span>
  uri <span class="o">=</span> <span class="s2">"ruby/bundle.tgz"</span>
</code></pre></div></div>

<p><strong>Q2:</strong>  [builder] /usr/local/lib/ruby/2.6.0/rubygems/core_ext/kernel_require.rb:54:in `requireâ€™: cannot load such file â€“ zlib (LoadError)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openfunction6@cloudshell:~/mph/samples/functions/Knative/hello-world-ruby<span class="nv">$ </span>pack build <span class="k">function</span><span class="nt">-ruby1</span> <span class="nt">--builder</span> penghuima/ruby26  <span class="nt">--env</span> <span class="nv">FUNC_NAME</span><span class="o">=</span><span class="s2">"Hello-World"</span>
v1: Pulling from penghuima/buildpacks-ruby26-run
Digest: sha256:241dbbb3eefe5ef0a4ee5d471933ed331eb6a18d20cf5cdeffb6f9da6a44cc35
Status: Image is up to <span class="nb">date </span><span class="k">for </span>penghuima/buildpacks-ruby26-run:v1
0.11.1: Pulling from buildpacksio/lifecycle
Digest: sha256:2ca9870d9472400792bdc2d43ded8df2642ffcf937e8cd01685836678c28780b
<span class="o">[</span>builder] Running <span class="s2">"bundle lock --add-platform x86_64-linux"</span>
<span class="o">[</span>builder] /usr/local/lib/ruby/2.6.0/rubygems/core_ext/kernel_require.rb:54:in <span class="sb">`</span>require<span class="s1">': cannot load such file -- zlib (LoadError)
[builder]       from /usr/local/lib/ruby/2.6.0/rubygems/core_ext/kernel_require.rb:54:in `require'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/bundler/fetcher.rb:6:in <span class="sb">`</span>&lt;top <span class="o">(</span>required<span class="o">)&gt;</span><span class="s1">'
[builder]       from /usr/local/lib/ruby/2.6.0/rubygems/core_ext/kernel_require.rb:54:in `require'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/rubygems/core_ext/kernel_require.rb:54:in <span class="sb">`</span>require<span class="s1">'
[builder]       from /usr/local/lib/ruby/2.6.0/bundler/cli/lock.rb:21:in `run'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/bundler/cli.rb:643:in <span class="sb">`</span>lock<span class="s1">'
[builder]       from /usr/local/lib/ruby/2.6.0/bundler/vendor/thor/lib/thor/command.rb:27:in `run'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/bundler/vendor/thor/lib/thor/invocation.rb:126:in <span class="sb">`</span>invoke_command<span class="s1">'
[builder]       from /usr/local/lib/ruby/2.6.0/bundler/vendor/thor/lib/thor.rb:387:in `dispatch'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/bundler/cli.rb:27:in <span class="sb">`</span>dispatch<span class="s1">'
[builder]       from /usr/local/lib/ruby/2.6.0/bundler/vendor/thor/lib/thor/base.rb:466:in `start'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/bundler/cli.rb:18:in <span class="sb">`</span>start<span class="s1">'
[builder]       from /usr/local/lib/ruby/gems/2.6.0/gems/bundler-1.17.2/exe/bundle:30:in `block in &lt;top (required)&gt;'</span>
<span class="o">[</span>builder]       from /usr/local/lib/ruby/2.6.0/bundler/friendly_errors.rb:124:in <span class="sb">`</span>with_friendly_errors<span class="s1">'
[builder]       from /usr/local/lib/ruby/gems/2.6.0/gems/bundler-1.17.2/exe/bundle:22:in `&lt;top (required)&gt;'</span>
<span class="o">[</span>builder]       from /usr/local/bin/bundle:23:in <span class="sb">`</span>load<span class="s1">'
[builder]       from /usr/local/bin/bundle:23:in `&lt;main&gt;'</span>
<span class="o">[</span>builder] Sorry your project couldn<span class="s1">'t be built.
[builder] Our documentation explains ways to configure Buildpacks to better recognise your project:
[builder]  -&gt; https://github.com/GoogleCloudPlatform/buildpacks/blob/main/README.md
[builder] If you think you'</span>ve found an issue, please report it:
<span class="o">[</span>builder]  -&gt; https://github.com/GoogleCloudPlatform/buildpacks/issues/new
<span class="o">[</span>builder] <span class="nt">--------------------------------------------------------------------------------</span>
<span class="o">[</span>builder] ERROR: failed to build: <span class="nb">exit </span>status 1
ERROR: failed to build: executing lifecycle. This may be the result of using an untrusted builder: failed with status code: 51
</code></pre></div></div>

<p><strong>A2ï¼š</strong>è¿™æ˜¯ç”±äº stack è¿è¡Œæ—¶å®‰è£…å°‘ä¾èµ– zlib å¯¼è‡´çš„,å®‰è£…rubyæ—¶ç¼ºå°‘ openssl å’Œ zlib</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">***</span> Following extensions are not compiled:
dbm:
        Could not be configured. It will not be installed.
        Check ext/dbm/mkmf.log <span class="k">for </span>more details.
gdbm:
        Could not be configured. It will not be installed.
        Check ext/gdbm/mkmf.log <span class="k">for </span>more details.
openssl:
        Could not be configured. It will not be installed.
        /tmp/ruby/ruby-2.6.7/ext/openssl/extconf.rb:97: OpenSSL library could not be found. You might want to use <span class="nt">--with-openssl-dir</span><span class="o">=</span>&lt;<span class="nb">dir</span><span class="o">&gt;</span>                            option to specify the prefix where OpenSSL is installed.
        Check ext/openssl/mkmf.log <span class="k">for </span>more details.
readline:
        Could not be configured. It will not be installed.
        /tmp/ruby/ruby-2.6.7/ext/readline/extconf.rb:62: Neither readline nor libedit was found
        Check ext/readline/mkmf.log <span class="k">for </span>more details.
zlib:
        Could not be configured. It will not be installed.
        Check ext/zlib/mkmf.log <span class="k">for </span>more details.
</code></pre></div></div>

<blockquote>
  <p>è§£å†³æ–¹æ¡ˆï¼Œ<a href="https://blog.csdn.net/qq_41690477/article/details/82750530">å‚è€ƒ 1</a>  <a href="https://blog.csdn.net/Wangdada111/article/details/73382554?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-1.control&amp;spm=1001.2101.3001.4242">å‚è€ƒ2</a></p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># install ruby runtime</span>
RUN <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> <span class="nb">mkdir </span>ruby <span class="o">&amp;&amp;</span> <span class="nb">cd </span>ruby <span class="o">&amp;&amp;</span> curl  https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.6.tar.gz | <span class="nb">tar </span>xz <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd </span>ruby-2.6.6 <span class="o">&amp;&amp;</span> ./configure <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make <span class="nb">install</span>  <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd </span>ext/zlib <span class="se">\</span>
    <span class="o">&amp;&amp;</span> ruby extconf.rb <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s?$(top_srcdir)?../..?g'</span> Makefile  <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make <span class="nb">install</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ../openssl <span class="se">\</span>
    <span class="o">&amp;&amp;</span> ruby extconf.rb <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s?$(top_srcdir)?../..?g'</span> Makefile <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make <span class="nb">install</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> gem uninstall bundle <span class="o">&amp;&amp;</span> gem <span class="nb">install </span>bundler <span class="nt">-v</span> 2.1.4 <span class="se">\</span>
</code></pre></div></div>

<p><strong>Q3ï¼š</strong>ç¼ºå°‘ Gemfile.lockæ–‡ä»¶</p>

<p><strong>A3:</strong>  è¡¥å……æ–‡ä»¶ï¼Œæ³¨æ„ä¾èµ–ç‰ˆæœ¬é—®é¢˜</p>

<p><strong>Q4ï¼š</strong>stack é‡Œ build å’Œ run é•œåƒ bundler ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œä¸€ä¸ªä¸º 2.1.4 ï¼Œä¸€ä¸ªä¸º 1.17.2</p>

<p><strong>A4ï¼š</strong> å¸è½½é»˜è®¤bundlerç‰ˆæœ¬ï¼Œç»Ÿä¸€ç‰ˆæœ¬ä¸º2.1.4</p>

:ET